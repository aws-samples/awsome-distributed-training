#!/bin/bash

echo "=========================================="
echo "NIXL+Dynamo Docker Environment"
echo "=========================================="
echo "Target GPU: ${CUDA_ARCH_NAME:-Unknown} (${CUDA_ARCH_FAMILY:-Unknown} family)"
echo "CUDA Architecture: SM${CUDAARCHS}"
echo "Compute Capability: ${CUDA_COMPUTE_CAPABILITY}"
echo ""

echo "=== Installed Components ==="
echo "Core System:"
echo "  - CUDA: $(nvcc --version 2>/dev/null | grep release | cut -d',' -f2 | xargs || echo 'not found')"
echo "  - GDRCopy: ${GDRCOPY_VERSION:-not set}"
echo "  - UCX: ${UCX_REF:-not set} [at /usr/local/ucx]"
echo ""

echo "Networking & RDMA:"
echo "  - libfabric: ${LIBFABRIC_VERSION:-not set}"
echo "  - EFA Installer: ${EFA_INSTALLER_VERSION:-not set}"
echo "  - PMIx: ${PMIX_VERSION:-not set}"
echo ""

echo "ML/Communication Libraries:"
echo "  - NCCL: ${NCCL_VERSION:-not set}"
echo "  - AWS-OFI-NCCL Plugin: ${AWS_OFI_NCCL_VERSION:-not set}"
echo "  - NVSHMEM: ${NVSHMEM_VERSION:-not set}"
echo ""

echo "Messaging, Data & Storage:"
echo "  - NATS Server: ${NATS_VERSION:-not set} ($(nats-server --version 2>/dev/null | head -1 || echo 'not installed'))"
echo "  - ETCD Server: $(etcd --version 2>/dev/null | head -1 | awk '{print $3}' || echo 'not installed')"
echo "  - ETCD C++ API: ${ETCD_CPP_VERSION:-not set}"
echo "  - AWS SDK C++: ${AWS_SDK_VERSION:-not set}"
echo "  - cpprestsdk: installed"
echo ""

echo "Development Tools:"
echo "  - Rust: ${RUST_VERSION:-not set}"
echo "  - Python: $(python3 --version 2>/dev/null || echo 'not found')"
echo "  - NIXL: ${NIXL_REF:-installed from source}"
echo "    • Location: /usr/local/nixl"
echo "    • Dynamo symlink: /opt/nvidia/nvda_nixl"
echo "  - nixlbench: $(which nixlbench 2>/dev/null || echo 'not in PATH')"
echo "  - kvbench: $(python3 -c 'import kvbench' 2>/dev/null && echo 'installed' || echo 'not found')"
echo ""

echo "=== Environment Paths ==="
echo "NIXL_PREFIX: ${NIXL_PREFIX}"
echo "NIXL_PLUGIN_DIR: ${NIXL_PLUGIN_DIR}"
echo "NIXL_ETCD_NAMESPACE: ${NIXL_ETCD_NAMESPACE}"
echo ""

echo "=== Available Test Commands ==="
echo "  nixl-validate       - Comprehensive environment validation"
echo "  efa-test            - EFA functionality test (requires EFA hardware)"
echo "  nixlbench-test      - Run basic nixlbench tests"
echo "  env-info            - Show this information"
echo ""

echo "=== Quick Start ==="
echo "  # Validate installation:"
echo "  nixl-validate"
echo ""
echo "  # Test NIXL Python:"
echo "  python3 -c 'import nixl; print(dir(nixl))'"
echo ""
echo "  # Start NATS (for Dynamo):"
echo "  nats-server -p 4222 &"
echo ""
echo "  # Start ETCD (for NIXL/kvbench):"
echo "  etcd --listen-client-urls http://0.0.0.0:2379 \\"
echo "       --advertise-client-urls http://localhost:2379 &"
echo "  sleep 2"
echo ""
echo "  # Run nixlbench with UCX backend:"
echo "  nixlbench --etcd_endpoints http://localhost:2379 --backend UCX"
echo ""
echo "  # Run nixlbench with libfabric/EFA (requires EFA hardware):"
echo "  nixlbench --etcd_endpoints http://localhost:2379 --backend LIBFABRIC"
echo ""
echo "  # Run kvbench (Python):"
echo "  cd /workspace/nixl/benchmark/kvbench"
echo "  python3 -m kvbench.run --help"
echo ""

echo "=== Dynamo Integration ==="
echo "This base image is compatible with both:"
echo "  • Dynamo + vLLM (inference backend)"
echo "  • Dynamo + TensorRT-LLM (inference backend)"
echo ""
echo "To extend with a framework, use this as the base stage:"
echo "  FROM <this-image>:latest AS dynamo-vllm"
echo "  # Add vLLM installation..."
echo ""

echo "For EFA testing (requires EFA-enabled instance):"
echo "  efa-test"
echo ""

echo "=========================================="