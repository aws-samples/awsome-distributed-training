# ADOT Collector Configuration for Prometheus Scraping
# 
# NOTE: This file contains variables that must be substituted before applying:
#   ${AMP_ENDPOINT} - Your AMP workspace remote write endpoint
#   ${AWS_REGION_AMGP} - AWS region where AMP is deployed
#
# Use deploy-obs.sh script which handles variable substitution automatically,
# or manually substitute with envsubst or sed before applying.
#
---
apiVersion: v1
kind: Namespace
metadata:
  name: adot-col
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: adot-col-prom-metrics
  namespace: adot-col
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: adot-prometheus-role
rules:
  - apiGroups: [""]
    resources:
      - nodes
      - nodes/proxy
      - services
      - endpoints
      - pods
    verbs: ["get", "list", "watch"]
  - apiGroups: ["extensions", "networking.k8s.io"]
    resources:
      - ingresses
    verbs: ["get", "list", "watch"]
  - nonResourceURLs: ["/metrics"]
    verbs: ["get"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: adot-prometheus-role-binding
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: adot-prometheus-role
subjects:
  - kind: ServiceAccount
    name: adot-col-prom-metrics
    namespace: adot-col
---
apiVersion: opentelemetry.io/v1alpha1
kind: OpenTelemetryCollector
metadata:
  name: adot-prometheus
  namespace: adot-col
spec:
  mode: deployment
  serviceAccount: adot-col-prom-metrics
  config: |
    receivers:
      prometheus:
        config:
          global:
            scrape_interval: 30s
            scrape_timeout: 10s
          scrape_configs:
          - job_name: 'dcgm-exporter'
            metrics_path: /metrics
            kubernetes_sd_configs:
            - role: endpoints
              namespaces:
                names:
                - gpu-operator
            tls_config:
              ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
              insecure_skip_verify: true
            bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
            relabel_configs:
            # Keep only DCGM exporter endpoints
            - source_labels: [__meta_kubernetes_service_name]
              action: keep
              regex: .*dcgm-exporter.*
            # Add node name as label
            - source_labels: [__meta_kubernetes_pod_node_name]
              action: replace
              target_label: kubernetes_node
            # Add pod name as label
            - source_labels: [__meta_kubernetes_pod_name]
              action: replace
              target_label: pod
            # Add namespace as label
            - source_labels: [__meta_kubernetes_namespace]
              action: replace
              target_label: namespace
            # Add service name as label
            - source_labels: [__meta_kubernetes_service_name]
              action: replace
              target_label: service

    exporters:
      prometheusremotewrite:
        endpoint: ${AMP_ENDPOINT}
        auth:
          authenticator: sigv4auth
      debug:
        verbosity: detailed

    extensions:
      sigv4auth:
        region: ${AWS_REGION_AMGP}
        service: aps

    service:
      extensions: [sigv4auth]
      pipelines:
        metrics:
          receivers: [prometheus]
          exporters: [debug, prometheusremotewrite]
