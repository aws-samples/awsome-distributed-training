# Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
# SPDX-License-Identifier: MIT-0
#
# AWS Batch setup for P6 distributed training with multi-node NCCL tests
# Author: yusongw@
# See README.md for detailed usage instructions
#
AWSTemplateFormatVersion: '2010-09-09'
Description: AWS Batch setup for P6 distributed training with multi-node NCCL tests. Simplified deployment with inline container setup.

Parameters:
  VPCStackParameter:
    Type: String
    Description: Private subnets will be retrieved for the compute environment
    Default: 'aws-batch-vpc'
  CapacityReservationId:
    Type: String
    Description: Capacity Reservation ID (e.g., cr-1234567890)
    Default: ''

Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: General configuration
        Parameters:
          - VPCStackParameter
    ParameterLabels:
      VPCStackParameter:
        default: Name of the VPC Stack

Resources:
  ###################
  ## KMS Key for Secrets Manager ##
  ###################
  SecretsKMSKey:
    Type: AWS::KMS::Key
    Properties:
      Description: KMS key for encrypting Batch SSH secrets
      EnableKeyRotation: true
      KeyPolicy:
        Version: '2012-10-17'
        Statement:
          - Sid: Enable IAM User Permissions
            Effect: Allow
            Principal:
              AWS: !Sub 'arn:aws:iam::${AWS::AccountId}:root'
            Action: 'kms:*'
            Resource: '*'
          - Sid: Allow Secrets Manager to use the key
            Effect: Allow
            Principal:
              Service: secretsmanager.amazonaws.com
            Action:
              - 'kms:Decrypt'
              - 'kms:GenerateDataKey'
            Resource: '*'

  SecretsKMSKeyAlias:
    Type: AWS::KMS::Alias
    Properties:
      AliasName: !Sub 'alias/${AWS::StackName}-secrets'
      TargetKeyId: !Ref SecretsKMSKey

  ###################
  ## EC2 Resources ##
  ###################
  DistributedDeepLearningLT:
    Type: AWS::EC2::LaunchTemplate
    Properties:
      LaunchTemplateData:
        MetadataOptions:
          HttpTokens: required  # Enforce IMDSv2
          HttpEndpoint: enabled
          HttpPutResponseHopLimit: 1
        InstanceMarketOptions:
          MarketType: "capacity-block"
        CapacityReservationSpecification:
          CapacityReservationTarget:
            CapacityReservationId: !Ref CapacityReservationId
        NetworkInterfaces:
          - Description: EFA Interface
            Groups: !Split
              - ','
              - Fn::ImportValue: !Sub ${VPCStackParameter}-SecurityGroup
            NetworkCardIndex: 0
            DeviceIndex: 0
            DeleteOnTermination: true
            InterfaceType: efa
          - Description: EFA Interface
            Groups: !Split
              - ','
              - Fn::ImportValue: !Sub ${VPCStackParameter}-SecurityGroup
            NetworkCardIndex: 1
            DeviceIndex: 0
            DeleteOnTermination: true
            InterfaceType: efa
          - Description: EFA Interface
            Groups: !Split
              - ','
              - Fn::ImportValue: !Sub ${VPCStackParameter}-SecurityGroup
            NetworkCardIndex: 2
            DeviceIndex: 0
            DeleteOnTermination: true
            InterfaceType: efa
          - Description: EFA Interface
            Groups: !Split
              - ','
              - Fn::ImportValue: !Sub ${VPCStackParameter}-SecurityGroup
            NetworkCardIndex: 3
            DeviceIndex: 0
            DeleteOnTermination: true
            InterfaceType: efa
          - Description: EFA Interface
            Groups: !Split
              - ','
              - Fn::ImportValue: !Sub ${VPCStackParameter}-SecurityGroup
            NetworkCardIndex: 4
            DeviceIndex: 0
            DeleteOnTermination: true
            InterfaceType: efa
          - Description: EFA Interface
            Groups: !Split
              - ','
              - Fn::ImportValue: !Sub ${VPCStackParameter}-SecurityGroup
            NetworkCardIndex: 5
            DeviceIndex: 0
            DeleteOnTermination: true
            InterfaceType: efa
          - Description: EFA Interface
            Groups: !Split
              - ','
              - Fn::ImportValue: !Sub ${VPCStackParameter}-SecurityGroup
            NetworkCardIndex: 6
            DeviceIndex: 0
            DeleteOnTermination: true
            InterfaceType: efa
          - Description: EFA Interface
            Groups: !Split
              - ','
              - Fn::ImportValue: !Sub ${VPCStackParameter}-SecurityGroup
            NetworkCardIndex: 7
            DeviceIndex: 0
            DeleteOnTermination: true
            InterfaceType: efa

  ########################
  ## Batch Architecture ##
  ########################

  ##
  ## IAM Roles for AWS Batch
  ##
  BatchInstanceRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          -
            Effect: Allow
            Principal:
              Service:
                - batch.amazonaws.com
            Action:
              - sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSBatchServiceRole

  SecretsManagerPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      Description: Policy for reading SSH secrets from Secrets Manager
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Action:
              - secretsmanager:GetSecretValue
            Resource:
              - !Sub 'arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${AWS::StackName}-ssh-key-*'
          - Effect: Allow
            Action:
              - kms:Decrypt
            Resource:
              - !GetAtt SecretsKMSKey.Arn

  ECSTaskServiceRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          -
            Effect: Allow
            Principal:
              Service:
                - ec2.amazonaws.com
            Action:
              - sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AmazonEC2ContainerServiceforEC2Role
        - !Ref SecretsManagerPolicy

  ECSTaskInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Path: /
      Roles:
        - !Ref ECSTaskServiceRole
      InstanceProfileName: !Join [ "", [ "ECSTaskInstanceProfileIAM-", !Ref AWS::StackName ] ]

  BatchJobRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - ecs-tasks.amazonaws.com
            Action:
              - sts:AssumeRole
      ManagedPolicyArns:
        - !Ref SecretsManagerPolicy

  ##
  ## Secrets Manager - Placeholder for SSH key (populate manually after stack creation)
  ##
  SSHKeySecret:
    Type: AWS::SecretsManager::Secret
    Metadata:
      cfn_nag:
        rules_to_suppress:
          - id: W77
            reason: "SSH keys for Batch MNP do not require automatic rotation"
      guard:
        SuppressedRules:
          - SECRETSMANAGER_ROTATION_ENABLED_CHECK
    Properties:
      Name: !Sub "${AWS::StackName}-ssh-key"
      Description: "SSH private key for Batch MNP jobs - populate with: ssh-keygen -t rsa -b 2048 -N '' -f /tmp/batch_key && aws secretsmanager put-secret-value --secret-id <secret-arn> --secret-string file:///tmp/batch_key"
      SecretString: "PLACEHOLDER - Run the command in Description to generate and upload SSH key"
      KmsKeyId: !Ref SecretsKMSKey

  ##
  ## Compute Environment and Job Definition
  ##
  DistributedDeepLearningCE:
    Type: AWS::Batch::ComputeEnvironment
    Properties:
      Type: MANAGED
      ServiceRole: !Ref BatchInstanceRole
      ComputeResources:
        AllocationStrategy: BEST_FIT
        MaxvCpus: 100000
        DesiredvCpus: 0
        MinvCpus: 0
        Subnets: !Split
          - ','
          - Fn::ImportValue: !Sub ${VPCStackParameter}-PrivateSubnet
        Type: EC2
        InstanceRole: !Ref ECSTaskInstanceProfile
        Ec2Configuration:
          - ImageType: ECS_AL2023_NVIDIA
        LaunchTemplate:
          LaunchTemplateId: !Ref DistributedDeepLearningLT
          Version: $Latest
        InstanceTypes:
          - p6-b200.48xlarge
      State: ENABLED
      Tags:
        Name: Batch Deep Learning

  DistributedDeepLearningJQ:
    Type: AWS::Batch::JobQueue
    Properties:
      JobQueueName: !Sub "${AWS::StackName}-job-queue"
      ComputeEnvironmentOrder:
        - ComputeEnvironment: !Ref DistributedDeepLearningCE
          Order: 1
      Priority: 1
      State: "ENABLED"

  ##
  ## AWS Batch Job definition
  ##
  NCCLTest:
    Type: AWS::Batch::JobDefinition
    Properties:
      JobDefinitionName: !Sub "${AWS::StackName}-nccl-test"
      Type: multinode
      NodeProperties:
        MainNode: 0
        NumNodes: 2
        NodeRangeProperties:
          - TargetNodes: '0:'
            Container:
              # Use base nccl-tests image from public ECR
              Image: public.ecr.aws/hpc-cloud/nccl-tests:latest
              JobRoleArn: !GetAtt BatchJobRole.Arn
              # Inline command that sets up SSH and hostfile, then runs NCCL test
              Command:
                - /bin/bash
                - -c
                - |
                  set -euo pipefail
                  export PATH="/usr/local/bin:/usr/sbin:$PATH"
                  echo "Node ${AWS_BATCH_JOB_NODE_INDEX}/${AWS_BATCH_JOB_NUM_NODES} starting"
                  
                  # Fetch SSH key from Secrets Manager
                  mkdir -p /root/.ssh
                  chmod 700 /root/.ssh
                  /usr/local/bin/aws --region "${AWS_DEFAULT_REGION}" secretsmanager get-secret-value --secret-id "${SSH_SECRET_ARN}" --query SecretString --output text > /root/.ssh/id_rsa
                  chmod 600 /root/.ssh/id_rsa
                  ssh-keygen -y -f /root/.ssh/id_rsa > /root/.ssh/id_rsa.pub
                  cat /root/.ssh/id_rsa.pub > /root/.ssh/authorized_keys
                  chmod 600 /root/.ssh/authorized_keys
                  
                  # Start SSH daemon
                  mkdir -p /run/sshd
                  /usr/sbin/sshd || echo "ERROR: sshd failed to start"
                  sleep 1
                  
                  # Get container IP address (not host IP) - in awsvpc mode, container has its own ENI
                  MY_IP=$(hostname -i | awk '{print $1}')
                  
                  if [ "${AWS_BATCH_JOB_NUM_NODES}" -eq 1 ]; then
                    # Single node job
                    exec /opt/amazon/openmpi/bin/mpirun --allow-run-as-root -np "${NCCL_TOTAL_PROCS}" --bind-to none -x PATH -x LD_LIBRARY_PATH -x FI_PROVIDER=efa -x FI_EFA_USE_DEVICE_RDMA=1 -x FI_EFA_FORK_SAFE=1 ${NCCL_TEST_CMD}
                  fi
                  
                  if [ "${AWS_BATCH_JOB_NODE_INDEX}" -eq "${AWS_BATCH_JOB_MAIN_NODE_INDEX}" ]; then
                    # Main node: register own IP and collect worker IPs
                    mkdir -p /tmp/hosts
                    echo "${MY_IP}" > /tmp/hosts/${AWS_BATCH_JOB_NODE_INDEX}
                    echo "Main node waiting for ${AWS_BATCH_JOB_NUM_NODES} nodes"
                    
                    while [ "$(ls /tmp/hosts 2>/dev/null | wc -l)" -lt "${AWS_BATCH_JOB_NUM_NODES}" ]; do
                      sleep 1
                    done
                    
                    # Build hostfile
                    for idx in $(ls /tmp/hosts | sort -n); do
                      ip="$(cat /tmp/hosts/${idx})"
                      echo "${ip} slots=${NCCL_PROCS_PER_NODE}" >> /tmp/hostfile
                    done
                    
                    echo "Hostfile:"
                    cat /tmp/hostfile
                    
                    # Launch NCCL test - exclude loopback and bridge interfaces
                    export NCCL_SOCKET_IFNAME=^lo,docker,ecs
                    export NCCL_DEBUG=WARN
                    exec /opt/amazon/openmpi/bin/mpirun --allow-run-as-root --mca btl tcp,self -np "${NCCL_TOTAL_PROCS}" --hostfile /tmp/hostfile --bind-to none -x PATH -x LD_LIBRARY_PATH -x NCCL_SOCKET_IFNAME -x NCCL_NET_PLUGIN=ofi -x FI_PROVIDER=efa -x FI_EFA_USE_DEVICE_RDMA=1 -x FI_EFA_FORK_SAFE=1 -x FI_EFA_ENABLE_SHM_TRANSFER=1 -x NCCL_DEBUG ${NCCL_TEST_CMD}
                  else
                    # Worker node: register with main
                    for i in 1 2 3 4 5; do
                      if ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o ConnectTimeout=5 -o BatchMode=yes root@"${AWS_BATCH_JOB_MAIN_NODE_PRIVATE_IPV4_ADDRESS}" "mkdir -p /tmp/hosts && echo '${MY_IP}' > /tmp/hosts/${AWS_BATCH_JOB_NODE_INDEX}"; then
                        echo "Registered with main node"
                        break
                      fi
                      sleep 1
                    done
                    
                    # Wait for mpirun
                    tail -f /dev/null
                  fi
              Environment:
                - Name: AWS_DEFAULT_REGION
                  Value: !Ref AWS::Region
                - Name: LD_LIBRARY_PATH
                  Value: /opt/amazon/openmpi/lib:/opt/nccl/build/lib:/opt/amazon/efa/lib:/opt/aws-ofi-nccl/install/lib:/usr/local/nvidia/lib:$LD_LIBRARY_PATH
                - Name: PATH
                  Value: $PATH:/opt/amazon/efa/bin:/usr/bin
                - Name: NCCL_PROCS_PER_NODE
                  Value: "8"
                - Name: NCCL_TOTAL_PROCS
                  Value: "16"
                - Name: NCCL_TEST_CMD
                  Value: "/opt/nccl-tests/build/all_reduce_perf -b 8 -e 16G -f 2 -g 1 -c 1 -n 100"
                - Name: SSH_SECRET_ARN
                  Value: !Sub 'arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${AWS::StackName}-ssh-key'
              ResourceRequirements:
                - Type: VCPU
                  Value: 192
                - Type: GPU
                  Value: 8
                - Type: MEMORY
                  Value: 1049000
              Ulimits:
                - Name: memlock
                  HardLimit: -1
                  SoftLimit: -1
                - Name: stack
                  HardLimit: 67108864
                  SoftLimit: 67108864
                - Name: nofile
                  HardLimit: 1024000
                  SoftLimit: 1024000
              LinuxParameters:
                SharedMemorySize: 49152
                # Expose the first 8 uverbs devices for EFA on p6-b200
                Devices:
                  - HostPath: /dev/infiniband/uverbs0
                    ContainerPath: /dev/infiniband/uverbs0
                    Permissions:
                      - READ
                      - WRITE
                      - MKNOD
                  - HostPath: /dev/infiniband/uverbs1
                    ContainerPath: /dev/infiniband/uverbs1
                    Permissions:
                      - READ
                      - WRITE
                      - MKNOD
                  - HostPath: /dev/infiniband/uverbs2
                    ContainerPath: /dev/infiniband/uverbs2
                    Permissions:
                      - READ
                      - WRITE
                      - MKNOD
                  - HostPath: /dev/infiniband/uverbs3
                    ContainerPath: /dev/infiniband/uverbs3
                    Permissions:
                      - READ
                      - WRITE
                      - MKNOD
                  - HostPath: /dev/infiniband/uverbs4
                    ContainerPath: /dev/infiniband/uverbs4
                    Permissions:
                      - READ
                      - WRITE
                      - MKNOD
                  - HostPath: /dev/infiniband/uverbs5
                    ContainerPath: /dev/infiniband/uverbs5
                    Permissions:
                      - READ
                      - WRITE
                      - MKNOD
                  - HostPath: /dev/infiniband/uverbs6
                    ContainerPath: /dev/infiniband/uverbs6
                    Permissions:
                      - READ
                      - WRITE
                      - MKNOD
                  - HostPath: /dev/infiniband/uverbs7
                    ContainerPath: /dev/infiniband/uverbs7
                    Permissions:
                      - READ
                      - WRITE
                      - MKNOD
      PropagateTags: true
      RetryStrategy:
        Attempts: 1

Outputs:
  SSHKeySecretArn:
    Description: ARN of the SSH private key secret in Secrets Manager
    Value: !Sub 'arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:${AWS::StackName}-ssh-key'

  JobDefinitionMultiInstance:
    Description: Job definition for Multi-node Parallel Jobs
    Value: !Ref NCCLTest

  DistributedDeepLearningJQ:
    Description: Job Queue
    Value: !Ref DistributedDeepLearningJQ