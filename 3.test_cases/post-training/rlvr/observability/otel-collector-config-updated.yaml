apiVersion: v1
kind: ConfigMap
metadata:
  name: hyperpod-observability-central-collector-config
  namespace: hyperpod-observability
data:
  collector.yaml: |
    receivers:
      prometheus:
        config:
          scrape_configs:
            - job_name: kubernetes-apiservers
              scrape_interval: 30s
              bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
              kubernetes_sd_configs:
                - role: endpoints
              relabel_configs:
                - action: keep
                  regex: default;kubernetes;https
                  source_labels:
                    - __meta_kubernetes_namespace
                    - __meta_kubernetes_service_name
                    - __meta_kubernetes_endpoint_port_name
                # Add cluster name and id as label
                - target_label: cluster_id
                  replacement: ${CLUSTER_ID}
                - target_label: cluster_name
                  replacement: ${CLUSTER_NAME}
              scheme: https
              tls_config:
                ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
                insecure_skip_verify: true

            - job_name: kube-state-metrics
              scrape_interval: 30s
              kubernetes_sd_configs:
                - role: service
              relabel_configs:
                - action: keep
                  regex: hyp-obs-kube-state-metrics 
                  source_labels:
                    - __meta_kubernetes_service_name
                - action: labelmap
                  regex: __meta_kubernetes_service_label_(.+)
                - source_labels:
                    - __meta_kubernetes_namespace
                  target_label: kubernetes_namespace
                - source_labels:
                    - __meta_kubernetes_service_name
                  target_label: kubernetes_name
                # Add cluster name and id as label
                - target_label: cluster_id
                  replacement: ${CLUSTER_ID}
                - target_label: cluster_name
                  replacement: ${CLUSTER_NAME}

            - job_name: kubeflow-trainer-metrics
              scrape_interval: 30s
              kubernetes_sd_configs:
                - role: service
              relabel_configs:
                - action: drop
                  regex: hp-training-operator-controller-manager-metrics-service
                  source_labels:
                    - __meta_kubernetes_service_name
                - action: keep
                  regex: (.*kubeflow.*-controller-manager|training-operator)
                  source_labels:
                    - __meta_kubernetes_service_name
                - action: keep
                  regex: monitoring-port
                  source_labels:
                    - __meta_kubernetes_service_port_name
                - action: labelmap
                  regex: __meta_kubernetes_service_label_(.+)
                - source_labels:
                    - __meta_kubernetes_namespace
                  target_label: kubernetes_namespace
                - source_labels:
                    - __meta_kubernetes_service_name
                  target_label: kubernetes_name
                # Add cluster name and id as label
                - target_label: cluster_id
                  replacement: ${CLUSTER_ID}
                - target_label: cluster_name
                  replacement: ${CLUSTER_NAME}
              metrics_path: /metrics

            - job_name: hp-training-operator-metrics
              scrape_interval: 30s
              kubernetes_sd_configs:
                - role: service
              relabel_configs:
                - action: keep
                  regex: hp-training-operator-controller-manager-metrics-service
                  source_labels:
                    - __meta_kubernetes_service_name
                - action: keep
                  regex: metrics-port
                  source_labels:
                    - __meta_kubernetes_service_port_name
                - action: labelmap
                  regex: __meta_kubernetes_service_label_(.+)
                - source_labels:
                    - __meta_kubernetes_namespace
                  target_label: kubernetes_namespace
                - source_labels:
                    - __meta_kubernetes_service_name
                  target_label: kubernetes_name
                # Add cluster name and id as label
                - target_label: cluster_id
                  replacement: ${CLUSTER_ID}
                - target_label: cluster_name
                  replacement: ${CLUSTER_NAME}
              metrics_path: /metrics
              scheme: http

            # ===== RAY METRICS SCRAPING - NEW SECTION =====
            - job_name: ray-head-metrics
              scrape_interval: 30s
              kubernetes_sd_configs:
                - role: pod
                  namespaces:
                    names:
                      - ${RAY_NAMESPACE}
              relabel_configs:
                # Keep only Ray head pods
                - source_labels: [__meta_kubernetes_pod_label_ray_io_node_type]
                  action: keep
                  regex: head
                # Keep only port 8080 (metrics endpoint)
                - source_labels: [__meta_kubernetes_pod_container_port_number]
                  action: keep
                  regex: "8080"
                # Add ray cluster name as label
                - source_labels: [__meta_kubernetes_pod_label_ray_io_cluster]
                  target_label: ray_io_cluster
                # Add pod name
                - source_labels: [__meta_kubernetes_pod_name]
                  target_label: pod
                # Add namespace
                - source_labels: [__meta_kubernetes_namespace]
                  target_label: namespace
                # Add container name
                - source_labels: [__meta_kubernetes_pod_container_name]
                  target_label: container
                # Add cluster name and id
                - target_label: cluster_id
                  replacement: ${CLUSTER_ID}
                - target_label: cluster_name
                  replacement: ${CLUSTER_NAME}

            - job_name: ray-worker-metrics
              scrape_interval: 30s
              kubernetes_sd_configs:
                - role: pod
                  namespaces:
                    names:
                      - ${RAY_NAMESPACE}
              relabel_configs:
                # Keep only Ray worker pods
                - source_labels: [__meta_kubernetes_pod_label_ray_io_node_type]
                  action: keep
                  regex: worker
                # Keep only port 8080 (metrics endpoint)
                - source_labels: [__meta_kubernetes_pod_container_port_number]
                  action: keep
                  regex: "8080"
                # Add ray cluster name as label
                - source_labels: [__meta_kubernetes_pod_label_ray_io_cluster]
                  target_label: ray_io_cluster
                # Add pod name
                - source_labels: [__meta_kubernetes_pod_name]
                  target_label: pod
                # Add namespace
                - source_labels: [__meta_kubernetes_namespace]
                  target_label: namespace
                # Add container name
                - source_labels: [__meta_kubernetes_pod_container_name]
                  target_label: container
                # Add cluster name and id
                - target_label: cluster_id
                  replacement: ${CLUSTER_ID}
                - target_label: cluster_name
                  replacement: ${CLUSTER_NAME}
            # ===== END RAY METRICS SCRAPING =====

    processors:
      batch:
        timeout: 5s
        send_batch_size: 5000
        send_batch_max_size: 6000

    exporters:
      debug:
        verbosity: detailed
      prometheusremotewrite:
        add_metric_suffixes: false
        endpoint: ${AMP_ENDPOINT}/api/v1/remote_write
        auth:
          authenticator: sigv4auth
        retry_on_failure:
          enabled: true
          initial_interval: 1s
          max_interval: 10s
          max_elapsed_time: 60s

    extensions:
      sigv4auth:
        region: ${AWS_REGION}
        service: "aps"

    service:
      extensions: [sigv4auth]
      pipelines:
        metrics:
          receivers: [prometheus]
          processors: [batch]
          exporters: [prometheusremotewrite]
